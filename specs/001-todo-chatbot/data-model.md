# Todo AI Chatbot Data Model

## Entity Definitions

### Task Entity

#### Fields
- **id** (UUID, Primary Key)
  - Type: UUID (generated by database)
  - Constraints: Not Null, Unique
  - Default: gen_random_uuid()
  - Purpose: Unique identifier for the task

- **user_id** (UUID, Foreign Key)
  - Type: UUID
  - Constraints: Not Null, References users(id)
  - Purpose: Links task to owning user for data isolation

- **title** (String)
  - Type: VARCHAR(255)
  - Constraints: Not Null
  - Validation: Length between 1-255 characters
  - Purpose: Brief title/description of the task

- **description** (Text)
  - Type: TEXT
  - Constraints: Nullable
  - Purpose: Detailed description of the task requirements

- **due_date** (Timestamp)
  - Type: TIMESTAMP
  - Constraints: Nullable
  - Format: ISO 8601 (YYYY-MM-DDTHH:mm:ss.sssZ)
  - Purpose: Deadline for task completion

- **priority** (String)
  - Type: VARCHAR(20)
  - Constraints: Not Null, Default 'medium'
  - Values: 'low' | 'medium' | 'high'
  - Purpose: Task importance level

- **category** (String)
  - Type: VARCHAR(100)
  - Constraints: Nullable
  - Purpose: Organizational grouping for tasks

- **completed** (Boolean)
  - Type: BOOLEAN
  - Constraints: Not Null, Default False
  - Purpose: Completion status of the task

- **completed_at** (Timestamp)
  - Type: TIMESTAMP
  - Constraints: Nullable
  - Purpose: Time when task was marked as completed

- **created_at** (Timestamp)
  - Type: TIMESTAMP
  - Constraints: Not Null, Default CURRENT_TIMESTAMP
  - Purpose: Time when task was created

- **updated_at** (Timestamp)
  - Type: TIMESTAMP
  - Constraints: Not Null, Default CURRENT_TIMESTAMP
  - Purpose: Time when task was last updated

#### Validation Rules
- Title length: 1-255 characters
- Priority: Only valid values ('low', 'medium', 'high')
- User_id: Must reference existing user in system
- Due date: Cannot be in past if task is not completed

#### State Transitions
- Pending (completed=False) â†’ Completed (completed=True, completed_at set)
- No backward transitions from completed state

#### Indexes
- Primary Key: id
- Composite: (user_id, created_at) for chronological queries
- Composite: (user_id, completed) for status-based filtering
- Composite: (user_id, due_date) for deadline-based queries
- Composite: (user_id, priority) for priority-based queries

---

### Conversation Entity

#### Fields
- **id** (UUID, Primary Key)
  - Type: UUID
  - Constraints: Not Null, Unique
  - Default: gen_random_uuid()
  - Purpose: Unique identifier for the conversation

- **user_id** (UUID, Foreign Key)
  - Type: UUID
  - Constraints: Not Null, References users(id)
  - Purpose: Links conversation to owning user for data isolation

- **title** (String)
  - Type: VARCHAR(255)
  - Constraints: Nullable
  - Purpose: Auto-generated title based on conversation topic

- **created_at** (Timestamp)
  - Type: TIMESTAMP
  - Constraints: Not Null, Default CURRENT_TIMESTAMP
  - Purpose: Time when conversation was initiated

- **updated_at** (Timestamp)
  - Type: TIMESTAMP
  - Constraints: Not Null, Default CURRENT_TIMESTAMP
  - Purpose: Time of last activity in conversation

- **last_accessed_at** (Timestamp)
  - Type: TIMESTAMP
  - Constraints: Not Null, Default CURRENT_TIMESTAMP
  - Purpose: Time when conversation was last accessed

#### Validation Rules
- User_id: Must reference existing user in system
- Title length: 0-255 characters (nullable)

#### Indexes
- Primary Key: id
- Index: user_id for user-scoped queries
- Composite: (user_id, updated_at) for chronological conversation retrieval
- Composite: (user_id, last_accessed_at) for recency-based queries

---

### Message Entity

#### Fields
- **id** (UUID, Primary Key)
  - Type: UUID
  - Constraints: Not Null, Unique
  - Default: gen_random_uuid()
  - Purpose: Unique identifier for the message

- **conversation_id** (UUID, Foreign Key)
  - Type: UUID
  - Constraints: Not Null, References conversations(id)
  - Purpose: Links message to parent conversation

- **user_id** (UUID, Foreign Key)
  - Type: UUID
  - Constraints: Not Null, References users(id)
  - Purpose: Links message to owning user (redundant safety check)

- **role** (String)
  - Type: VARCHAR(20)
  - Constraints: Not Null
  - Values: 'user' | 'assistant'
  - Purpose: Sender role of the message

- **content** (Text)
  - Type: TEXT
  - Constraints: Not Null
  - Purpose: Content of the message

- **tool_calls** (JSONB)
  - Type: JSONB
  - Constraints: Nullable
  - Purpose: Array of tool calls made in this message
  - Structure: Array of objects with id, name, arguments

- **tool_results** (JSONB)
  - Type: JSONB
  - Constraints: Nullable
  - Purpose: Results from tool executions
  - Structure: Array of objects with tool_call_id, result

- **created_at** (Timestamp)
  - Type: TIMESTAMP
  - Constraints: Not Null, Default CURRENT_TIMESTAMP
  - Purpose: Time when message was created

#### Validation Rules
- Role: Only valid values ('user', 'assistant')
- Content: Cannot be empty or whitespace-only
- Conversation_id: Must reference existing conversation
- User_id: Must reference existing user and match conversation's user
- Tool_calls: If present, must follow valid tool call schema

#### Indexes
- Primary Key: id
- Index: conversation_id for conversation-scoped queries
- Composite: (conversation_id, created_at) for chronological message retrieval
- Index: user_id for user-scoped queries
- Index: role for role-based filtering

## Entity Relationships

### User -> Task (One-to-Many)
- Each user can have multiple tasks
- Foreign key: user_id in Task entity references users(id)
- Cascading: Tasks deleted when user is deleted

### User -> Conversation (One-to-Many)
- Each user can have multiple conversations
- Foreign key: user_id in Conversation entity references users(id)
- Cascading: Conversations deleted when user is deleted

### Conversation -> Message (One-to-Many)
- Each conversation can have multiple messages
- Foreign key: conversation_id in Message entity references conversations(id)
- Cascading: Messages deleted when conversation is deleted

### Redundant Safety Check
- Message entity includes user_id as additional safety measure
- Ensures message ownership matches conversation ownership
- Provides protection against conversation ID manipulation

## Business Rules

### Data Isolation
- All queries must filter by user_id to ensure proper isolation
- No user should be able to access another user's data
- Foreign key constraints prevent data corruption

### Audit Trail
- All timestamps (created_at, updated_at) automatically managed by database
- Updated_at automatically updated on any record modification
- No direct modification of timestamp fields allowed

### Soft vs Hard Deletes
- Currently planned for hard deletes for simplicity
- Future enhancement could add soft delete capability with deleted_at timestamp

## Performance Considerations

### Query Optimization
- Composite indexes support common query patterns
- Foreign key indexes improve join performance
- JSONB indexes available for tool call queries if needed

### Partitioning
- Large tables could be partitioned by user_id or date in future
- Currently not needed for anticipated scale

### Caching
- Frequently accessed conversation metadata suitable for caching
- Message history caching with appropriate TTL
- Database query result caching for repetitive operations